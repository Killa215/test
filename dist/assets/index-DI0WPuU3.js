import{i as He,g as Je,a as Ve,b as Xe,c as ke,d as L,e as Q,r as he,u as Ye,f as pe,h as n,o as fe,j as e,E as Ze,k as W,l as Ie,y as K,m as re,n as ae,p as De,s as ne,q as ue,t as es,w as ss,v as as,x as ts,z as rs,A as ns,B as is,L as cs,C as os,H as ls,D as ds,F as Ce,N as Se,G as us,R as ms}from"./vendor-R5WW4-ta.js";import{l as hs}from"./lodash-BkzDGCz7.js";import{F as ps}from"./react-icons-Dq2N1vNE.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))v(l);new MutationObserver(l=>{for(const x of l)if(x.type==="childList")for(const p of x.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&v(p)}).observe(document,{childList:!0,subtree:!0});function h(l){const x={};return l.integrity&&(x.integrity=l.integrity),l.referrerPolicy&&(x.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?x.credentials="include":l.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function v(l){if(l.ep)return;l.ep=!0;const x=h(l);fetch(l.href,x)}})();const fs={apiKey:"AIzaSyBHedTqQer5Kbt7BrEwqSm5us1JaF19QWI",authDomain:"food-app-5cbe7.firebaseapp.com",databaseURL:"https://food-app-5cbe7-default-rtdb.firebaseio.com",projectId:"food-app-5cbe7",storageBucket:"food-app-5cbe7.appspot.com",messagingSenderId:"829389162673",appId:"1:829389162673:web:88a20e6434e1f029b87a90",measurementId:"G-Q7KFEJ7QNQ"};He(fs);const ce=Je(),E=Ve(),xe=Xe(),Z=ke(a=>({currentUser:null,isLoading:!0,fetchUserInfo:async i=>{if(!i)return a({currentUser:null,isLoading:!1});try{const h=L(E,"user",i),v=await Q(h);v.exists()?a({currentUser:v.data(),isLoading:!1}):a({currentUser:null,isLoading:!1})}catch(h){return console.error("Error fetching user info:",h),a({currentUser:null,isLoading:!1})}},setCurrentUser:i=>a(h=>({currentUser:{...h.currentUser,...i}}))})),ie=ke(a=>({chatId:null,user:null,isCurrentUserBlocked:!1,isReceivedBlocked:!1,isGroupChat:!1,changeChat:(i,h)=>{var p,j,A,I;const v=Z.getState().currentUser;if(!h||h.isGroup)return a({chatId:i,user:h,isCurrentUserBlocked:!1,isReceivedBlocked:!1,isGroupChat:!!(h!=null&&h.isGroup)});if(!v)return a({chatId:i,user:h,isCurrentUserBlocked:!1,isReceivedBlocked:!1,isGroupChat:!1});const l=((j=(p=h.blocked)==null?void 0:p.includes)==null?void 0:j.call(p,v.id))??!1,x=((I=(A=v.blocked)==null?void 0:A.includes)==null?void 0:I.call(A,h.id))??!1;return a({chatId:i,user:h,isCurrentUserBlocked:l,isReceivedBlocked:x,isGroupChat:!1})},changeBlock:()=>{a(i=>({...i,isReceivedBlocked:!i.isReceivedBlocked}))},resetChat:()=>{a({chatId:null,user:null,isCurrentUserBlocked:!1,isReceivedBlocked:!1,isGroupChat:!1})}})),me=async a=>{const h=he(xe,`images/${new Date().getTime()}_${a.name}`),v=Ye(h,a);return new Promise((l,x)=>{v.on("state_changed",p=>{const j=p.bytesTransferred/p.totalBytes*100;console.log("Upload is "+j+"% done")},p=>{x(p.code)},()=>{pe(v.snapshot.ref).then(p=>{l(p)})})})},xs=a=>{if(!a)return"unknown";const i=a.type.split("/")[0],h=a.name.split(".").pop().toLowerCase();return i==="image"?"image":i==="video"?"video":i==="audio"?"audio":["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"].includes(h)?"document":"file"},vs=()=>{var ye;const[a,i]=n.useState(null),[h,v]=n.useState(!1),[l,x]=n.useState(""),[p,j]=n.useState({file:null,url:"",type:""}),[A,I]=n.useState(!1),[M,D]=n.useState(!1),[o,b]=n.useState(0),[G,y]=n.useState([]),[F,f]=n.useState({}),[g,U]=n.useState(null),[r,c]=n.useState(!1),[t,d]=n.useState(""),[C,S]=n.useState(null),[N,m]=n.useState(""),B=n.useRef([]),R=n.useRef(null),k=n.useRef(null),P=n.useRef(null),oe=n.useRef(null),le=n.useRef(null),[ee,de]=n.useState({visible:!1,x:0,y:0,message:null}),{currentUser:z}=Z(),{chatId:Y,user:J,isCurrentUserBlocked:ve,isReceivedBlocked:ge}=ie();n.useEffect(()=>{var s;(s=oe.current)==null||s.scrollIntoView({behavior:"smooth"})},[a]),n.useEffect(()=>{const s=fe(L(E,"chats",Y),async u=>{const w=u.data();if(i(w),w&&(d(w.chatName||""),m(w.chatAvatar||"")),w!=null&&w.messages){const $=[...new Set(w.messages.map(T=>T.senderId))],_={...F};for(const T of $)if(!_[T]&&T!==z.id)try{const O=await Q(L(E,"user",T));O.exists()&&(_[T]=O.data().username)}catch(O){console.error("Error fetching user name:",O),_[T]="Неизвестный"}f(_)}});return()=>s()},[Y]),n.useEffect(()=>()=>{P.current&&P.current.state!=="inactive"&&P.current.stop(),clearInterval(le.current),je()},[]),n.useEffect(()=>{const s=()=>{ee.visible&&de({visible:!1,x:0,y:0,message:null})};return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[ee.visible]),n.useEffect(()=>{M?Le():je()},[M]);const Le=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!1});R.current&&(R.current.srcObject=s)}catch(s){console.error("Camera access error:",s),D(!1)}},je=()=>{var s;(s=R.current)!=null&&s.srcObject&&(R.current.srcObject.getTracks().forEach(u=>u.stop()),R.current.srcObject=null)},Ee=async()=>{if(R.current&&k.current){const s=k.current.getContext("2d");k.current.width=R.current.videoWidth,k.current.height=R.current.videoHeight,s.drawImage(R.current,0,0,k.current.width,k.current.height),k.current.toBlob(u=>{const w=new File([u],`photo_${Date.now()}.jpg`,{type:"image/jpeg"});j({file:w,url:URL.createObjectURL(u),type:"image"}),D(!1)},"image/jpeg",.9)}},Ae=async()=>{ve||ge||(A?Ue():Me())},Me=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),u=new MediaRecorder(s);P.current=u,B.current=[],u.ondataavailable=w=>{w.data.size>0&&B.current.push(w.data)},u.onstop=async()=>{const w=new Blob(B.current,{type:"audio/webm"}),$=URL.createObjectURL(w),_=new File([w],`voice_${Date.now()}.webm`,{type:"audio/webm"});j({file:_,url:$,type:"audio"}),s.getTracks().forEach(T=>T.stop())},u.start(100),I(!0),b(0),le.current=setInterval(()=>{b(w=>w+1)},1e3)}catch(s){console.error("Ошибка при записи голоса:",s),K.error("Не удалось начать запись голоса")}},Ue=()=>{P.current&&A&&(P.current.stop(),clearInterval(le.current),I(!1))},Be=(s,u)=>{s.preventDefault(),u.senderId===z.id&&de({visible:!0,x:s.clientX,y:s.clientY,message:u})},be=()=>{de({visible:!1,x:0,y:0,message:null})},Fe=async()=>{var s;if(ee.message)try{const u=L(E,"chats",Y);await W(u,{messages:Ie(ee.message)});const $=((s=(await Q(u)).data())==null?void 0:s.messages)||[];let _="Нет сообщений";if($.length>0){const O=$[$.length-1];_=O.text||we(O.mediaType)}const T=[z.id,J.id];for(const O of T){const V=L(E,"userchats",O),H=await Q(V);if(H.exists()){const se=H.data(),X=se.chats.findIndex(te=>te.chatId===Y);if(X!==-1){const te=[...se.chats];te[X]={...te[X],lastMessage:_,updatedAt:Date.now()},await W(V,{chats:te})}}}be(),K.success("Сообщение удалено")}catch(u){console.error("Ошибка при удалении сообщения:",u),K.error("Не удалось удалить сообщение")}},Pe=s=>{if(s.target.files[0]){const u=s.target.files[0],w=xs(u);j({file:u,url:URL.createObjectURL(u),type:w})}},Te=s=>{if(s.target.files[0]){const u=s.target.files[0];S(u),m(URL.createObjectURL(u))}},Ge=()=>{j({file:null,url:"",type:""})},Oe=s=>{x(u=>u+s.emoji)},Ne=async()=>{if(!(!l.trim()&&!p.file))try{let s=null,u=null;p.file&&(s=await me(p.file),u=p.type);const w={senderId:z.id,createdAt:new Date,...l.trim()&&{text:l.trim()},...s&&{media:s,mediaType:u}};await W(L(E,"chats",Y),{messages:re(w)});const $=l.trim()?l.trim():s?we(u):"";if($){const _=[z.id,J.id];for(const T of _){const O=L(E,"userchats",T),V=await Q(O);if(V.exists()){const H=V.data(),se=H.chats.findIndex(X=>X.chatId===Y);if(se!==-1){const X=[...H.chats];X[se]={...X[se],lastMessage:$,isSeen:T===z.id,updatedAt:Date.now()},await W(O,{chats:X})}}}}x(""),j({file:null,url:"",type:""})}catch(s){console.error("Ошибка при отправке сообщения:",s)}},$e=async()=>{try{const s=L(E,"chats",Y),u={};if(t&&t!==(a==null?void 0:a.chatName)&&(u.chatName=t),C){const w=await me(C);u.chatAvatar=w}else N===""&&(a!=null&&a.chatAvatar)&&(u.chatAvatar="");if(Object.keys(u).length>0){await W(s,u);const w=[z.id,J.id];for(const $ of w){const _=L(E,"userchats",$),T=await Q(_);if(T.exists()){const O=T.data(),V=O.chats.findIndex(H=>H.chatId===Y);if(V!==-1){const H=[...O.chats];H[V]={...H[V],...u.chatName&&{chatName:u.chatName},...u.chatAvatar!==void 0&&{chatAvatar:u.chatAvatar}},await W(_,{chats:H})}}}K.success("Изменения чата сохранены")}c(!1)}catch(s){console.error("Ошибка при сохранении изменений чата:",s),K.error("Не удалось сохранить изменения")}},we=s=>{switch(s){case"image":return"📷 Фото";case"video":return"🎬 Видео";case"audio":return"🎤 Голосовое сообщение";case"document":return"📄 Документ";default:return"📁 Файл"}},_e=s=>{if(!s)return null;switch(s.type){case"image":return e.jsx("img",{src:s.url,alt:"Превью изображения",className:"media-preview"});case"video":return e.jsxs("video",{controls:!0,className:"media-preview",children:[e.jsx("source",{src:s.url,type:"video/mp4"}),"Ваш браузер не поддерживает видео."]});case"audio":return e.jsx("div",{className:"audio-message-preview",children:e.jsxs("audio",{controls:!0,className:"media-preview",children:[e.jsx("source",{src:s.url,type:"audio/webm"}),"Ваш браузер не поддерживает аудио."]})});default:return e.jsxs("div",{className:"file-preview",children:[e.jsx("div",{className:"file-icon",children:"📄"}),e.jsx("div",{className:"file-name",children:s.file.name})]})}},qe=s=>{s.key==="Enter"&&(l.trim()||p.file)&&Ne()},We=s=>{const u=Math.floor(s/60),w=s%60;return`${u.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`},Qe=s=>s===z.id?z.username:F[s]||"Неизвестный",Ke=s=>{U((g==null?void 0:g.id)===s.id?null:s)},ze=s=>e.jsxs(e.Fragment,{children:[s.text&&e.jsx("p",{children:s.text}),s.media&&e.jsxs("div",{className:"media-container",children:[s.mediaType==="image"&&e.jsx("img",{src:s.media,alt:"",className:"media-content"}),s.mediaType==="video"&&e.jsxs("video",{controls:!0,className:"media-content",children:[e.jsx("source",{src:s.media,type:"video/mp4"}),"Ваш браузер не поддерживает видео."]}),s.mediaType==="audio"&&e.jsx("div",{className:"audio-message",children:e.jsxs("audio",{controls:!0,className:"media-content",children:[e.jsx("source",{src:s.media,type:"audio/webm"}),"Ваш браузер не поддерживает аудио."]})}),s.mediaType==="document"&&e.jsx("a",{href:s.media,target:"_blank",rel:"noopener noreferrer",className:"document-link",children:"📄 Документ"})]})]}),q=ve||ge;return e.jsxs("div",{className:"chat",onClick:be,children:[e.jsxs("div",{className:"top",children:[e.jsxs("div",{className:"user",children:[e.jsx("img",{src:(a==null?void 0:a.chatAvatar)||(J==null?void 0:J.avatar)||"../../../public/avatar.png",alt:""}),e.jsx("div",{className:"texts",children:e.jsx("span",{children:(a==null?void 0:a.chatName)||(J==null?void 0:J.username)})})]}),e.jsxs("div",{className:"icons",children:[e.jsx("img",{src:"../../../public/phone.png",alt:""}),e.jsx("img",{src:"../../../public/video.png",alt:""}),(a==null?void 0:a.isGroup)&&e.jsx("img",{src:"../../../public/edit.png",alt:"",onClick:()=>c(!0),style:{cursor:"pointer"}})]})]}),e.jsxs("div",{className:"center",children:[(ye=a==null?void 0:a.messages)==null?void 0:ye.map(s=>{var u,w;return e.jsxs("div",{className:`message ${s.senderId===z.id?"own":""} ${(g==null?void 0:g.id)===s.id?"selected":""}`,onClick:()=>Ke(s),onContextMenu:$=>Be($,s),children:[(s.senderId!==z.id||(a==null?void 0:a.isGroup))&&e.jsx("div",{className:"sender-info",children:e.jsx("span",{className:"sender-name",children:Qe(s.senderId)})}),e.jsx("div",{className:"texts",children:ze(s)})]},((w=(u=s.createdAt)==null?void 0:u.toMillis)==null?void 0:w.call(u))||s.createdAt)}),p.url&&e.jsx("div",{className:"message own",children:e.jsxs("div",{className:"texts",children:[_e(p),e.jsx("button",{className:"clear-media-btn",onClick:Ge,children:"×"})]})}),e.jsx("div",{ref:oe})]}),ee.visible&&e.jsx("div",{className:"context-menu",style:{position:"fixed",top:ee.y,left:ee.x-200,zIndex:1e3},onClick:s=>s.stopPropagation(),children:e.jsx("button",{className:"context-menu-item",onClick:Fe,children:"Удалить"})}),r&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"edit-chat-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Редактировать чат"}),e.jsx("button",{className:"close-btn",onClick:()=>c(!1),children:"×"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Название чата"}),e.jsx("input",{type:"text",value:t,onChange:s=>d(s.target.value),placeholder:"Введите название чата"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Аватар чата"}),e.jsxs("div",{className:"avatar-upload",children:[e.jsx("div",{className:"avatar-preview",children:e.jsx("img",{src:N||"../../../public/avatar.png",alt:"Аватар чата"})}),e.jsxs("div",{className:"avatar-upload-controls",children:[e.jsxs("label",{className:"upload-btn",children:["Выбрать файл",e.jsx("input",{type:"file",accept:"image/*",onChange:Te,style:{display:"none"}})]}),N&&e.jsx("button",{className:"remove-btn",onClick:()=>{m(""),S(null)},children:"Удалить"})]})]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:()=>c(!1),children:"Отмена"}),e.jsx("button",{className:"save-btn",onClick:$e,disabled:!t&&!C&&N==="",children:"Сохранить"})]})]})}),M&&e.jsx("div",{className:"webcam-modal-overlay",children:e.jsxs("div",{className:"webcam-modal",children:[e.jsxs("div",{className:"webcam-header",children:[e.jsx("h3",{children:"Сделайте фото"}),e.jsx("button",{className:"close-btn",onClick:()=>D(!1),children:"×"})]}),e.jsxs("div",{className:"webcam-preview-container",children:[e.jsx("video",{ref:R,autoPlay:!0,playsInline:!0,className:"webcam-video"}),e.jsx("canvas",{ref:k,style:{display:"none"}})]}),e.jsx("div",{className:"webcam-controls",children:e.jsx("button",{className:"capture-btn",onClick:Ee,children:e.jsx("div",{className:"capture-icon"})})})]})}),e.jsxs("div",{className:"bottom",children:[e.jsxs("div",{className:"icons",children:[e.jsx("label",{htmlFor:"file",children:e.jsx("img",{src:"../../../public/download.png",alt:"",className:q?"disabled":"",title:"Прикрепить файл"})}),e.jsx("input",{type:"file",id:"file",style:{display:"none"},onChange:q?void 0:Pe,disabled:q,accept:"image/*, video/*, audio/*, .pdf, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .txt"}),e.jsx("img",{src:"../../../public/camera.png",alt:"",className:q?"disabled":"",onClick:q?void 0:()=>D(!0),title:"Сделать фото"}),e.jsxs("div",{className:"mic-button-container",children:[e.jsx("img",{src:"../../../public/mic.png",alt:"",className:`mic-button ${A?"recording":""} ${q?"disabled":""}`,onClick:q?void 0:Ae,title:A?"Остановить запись":"Записать голосовое сообщение"}),A&&e.jsx("div",{className:"recording-time",children:We(o)})]})]}),e.jsx("input",{type:"text",value:l,onChange:s=>x(s.target.value),onKeyPress:qe,placeholder:q?"Вы не сможете отправить сообщение":"Сообщение...",disabled:q}),e.jsxs("div",{className:"emoji",children:[e.jsx("img",{src:"../../../public/emoji.png",alt:"",className:q?"disabled":"",onClick:q?void 0:()=>v(!h),title:"Эмодзи"}),h&&!q&&e.jsx("div",{className:"picker",children:e.jsx(Ze,{onEmojiClick:Oe})})]}),e.jsx("button",{className:"sendButton",onClick:Ne,disabled:q||!l.trim()&&!p.file,title:"Отправить",children:"Отправить"})]})]})},gs=()=>{const{chatId:a,user:i,isCurrentUserBlocked:h,isReceivedBlocked:v,changeBlock:l,resetChat:x}=ie(),{currentUser:p}=Z(),[j,A]=n.useState([]),[I,M]=n.useState([]),[D,o]=n.useState([]),[b,G]=n.useState("photos"),y=r=>{if(r.length<=30)return r;const c=r.split(".").pop();return`${r.substring(0,r.lastIndexOf(".")).substring(0,26-c.length)}...${c}`};n.useEffect(()=>{const r=fe(L(E,"chats",a),c=>{if(c.exists()){const d=(c.data().messages||[]).filter(m=>m.media||m.img),C=d.filter(m=>m.mediaType==="image"||m.img).map(m=>{var B;return{url:m.media||m.img,name:y(m.media?m.media.split("%2F").pop().split("?")[0]||`photo_${Date.now()}.jpg`:m.img.split("%2F").pop().split("?")[0]||`photo_${Date.now()}.jpg`),originalName:m.media?m.media.split("%2F").pop().split("?")[0]||`photo_${Date.now()}.jpg`:m.img.split("%2F").pop().split("?")[0]||`photo_${Date.now()}.jpg`,createdAt:((B=m.createdAt)==null?void 0:B.toDate())||new Date,type:"image"}}),S=d.filter(m=>m.mediaType==="document"||m.mediaType&&!["image","video","audio"].includes(m.mediaType)).map(m=>{var B;return{url:m.media,name:y(m.media.split("%2F").pop().split("?")[0]||`file_${Date.now()}`),originalName:m.media.split("%2F").pop().split("?")[0]||`file_${Date.now()}`,createdAt:((B=m.createdAt)==null?void 0:B.toDate())||new Date,type:"document"}}),N=d.filter(m=>m.mediaType==="audio").map(m=>{var B,R;return{url:m.media,name:`Голосовое сообщение ${new Date(((B=m.createdAt)==null?void 0:B.toDate())||new Date).toLocaleString()}`,createdAt:((R=m.createdAt)==null?void 0:R.toDate())||new Date,type:"audio",senderId:m.senderId}});A(C),M(S),o(N)}});return()=>r()},[a]);const F=async()=>{if(!i)return;const r=L(E,"user",p.id);try{await W(r,{blocked:v?Ie(i.id):re(i.id)}),l()}catch(c){console.error("Ошибка при блокировке/разблокировке пользователя:",c)}},f=async()=>{if(!(!(p!=null&&p.id)||!a))try{const r=L(E,"userchats",p.id),c=await Q(r);if(c.exists()){const d=(c.data().chats||[]).filter(C=>C.chatId!==a);await W(r,{chats:d})}x()}catch(r){console.error("Ошибка при выходе из чата:",r)}},g=async(r,c)=>{try{let t=r;if(r.includes("firebasestorage.googleapis.com"))try{const m=decodeURIComponent(r.split("/o/")[1].split("?")[0]),B=he(xe,m);t=await pe(B)}catch(m){console.error("Firebase download error:",m)}const C=await(await fetch(t)).blob(),S=window.URL.createObjectURL(C),N=document.createElement("a");N.href=S,N.download=c||`download_${Date.now()}`,document.body.appendChild(N),N.click(),setTimeout(()=>{document.body.removeChild(N),window.URL.revokeObjectURL(S)},100)}catch(t){console.error("Download failed:",t),alert("Не удалось скачать файл. Попробуйте вручную через правую кнопку мыши.")}},U=r=>r.type==="image"?e.jsx("img",{src:r.url,alt:`Photo ${r.name}`,className:"media-preview",onError:c=>{c.target.onerror=null,c.target.src="../../../public/avatar.png"}}):r.type==="audio"?e.jsx("div",{className:"audio-preview",children:e.jsxs("audio",{controls:!0,className:"audio-player",children:[e.jsx("source",{src:r.url,type:"audio/webm"}),"Ваш браузер не поддерживает аудио."]})}):e.jsxs("div",{className:"file-preview",children:[e.jsx("div",{className:"file-icon",children:"📄"}),e.jsx("div",{className:"file-name",title:r.originalName,children:r.name})]});return e.jsxs("div",{className:"detail",children:[e.jsxs("div",{className:"user",children:[e.jsx("img",{src:(i==null?void 0:i.avatar)||"../../../public/avatar.png",alt:"Avatar",onError:r=>{r.target.onerror=null,r.target.src="../../../public/avatar.png"}}),e.jsx("h2",{children:i==null?void 0:i.username})]}),e.jsxs("div",{className:"info",children:[e.jsxs("div",{className:"tabs",children:[e.jsx("button",{className:b==="photos"?"active":"",onClick:()=>G("photos"),children:"Фото"}),e.jsx("button",{className:b==="files"?"active":"",onClick:()=>G("files"),children:"Файлы"}),e.jsx("button",{className:b==="audio"?"active":"",onClick:()=>G("audio"),children:"Голосовые"})]}),b==="photos"&&e.jsxs("div",{className:"option",children:[e.jsxs("div",{className:"title",children:[e.jsx("span",{children:"Фотографии"}),e.jsx("span",{className:"count",children:j.length})]}),e.jsx("div",{className:"media-container",children:j.length>0?j.map((r,c)=>e.jsxs("div",{className:"media-item",children:[e.jsxs("div",{className:"media-content",children:[U(r),e.jsx("div",{className:"media-info",children:e.jsx("span",{children:new Date(r.createdAt).toLocaleDateString()})})]}),e.jsx("img",{src:"../../../public/download.png",alt:"Download",className:"icon",onClick:()=>g(r.url,r.originalName),title:"Скачать изображение",onError:t=>{t.target.onerror=null,t.target.src="../../../public/avatar.png"}})]},c)):e.jsx("p",{className:"no-media",children:"Нет загруженных фотографий"})})]}),b==="files"&&e.jsxs("div",{className:"option",children:[e.jsxs("div",{className:"title",children:[e.jsx("span",{children:"Файлы"}),e.jsx("span",{className:"count",children:I.length})]}),e.jsx("div",{className:"media-container",children:I.length>0?I.map((r,c)=>e.jsxs("div",{className:"media-item",children:[e.jsxs("div",{className:"media-content",children:[U(r),e.jsxs("div",{className:"media-info",children:[e.jsx("span",{children:r.name}),e.jsx("span",{children:new Date(r.createdAt).toLocaleDateString()})]})]}),e.jsx("img",{src:"../../../public/download.png",alt:"Download",className:"icon",onClick:()=>g(r.url,r.originalName),title:"Скачать файл",onError:t=>{t.target.onerror=null,t.target.src="../../../public/avatar.png"}})]},c)):e.jsx("p",{className:"no-media",children:"Нет загруженных файлов"})})]}),b==="audio"&&e.jsxs("div",{className:"option",children:[e.jsxs("div",{className:"title",children:[e.jsx("span",{children:"Голосовые сообщения"}),e.jsx("span",{className:"count",children:D.length})]}),e.jsx("div",{className:"audio-container",children:D.length>0?D.map((r,c)=>e.jsxs("div",{className:"audio-item",children:[e.jsxs("div",{className:"audio-content",children:[U(r),e.jsxs("div",{className:"audio-info",children:[e.jsx("span",{children:new Date(r.createdAt).toLocaleString()}),e.jsx("span",{className:"audio-sender",children:r.senderId===p.id?"Вы":(i==null?void 0:i.username)||"Неизвестный"})]})]}),e.jsx("img",{src:"../../../public/download.png",alt:"Download",className:"icon",onClick:()=>g(r.url,`voice_${c}.webm`),title:"Скачать аудио",onError:t=>{t.target.onerror=null,t.target.src="../../../public/avatar.png"}})]},c)):e.jsx("p",{className:"no-media",children:"Нет голосовых сообщений"})})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{onClick:F,children:h?"Пользователь заблокирован":v?"Разблокировать":"Заблокировать"}),e.jsx("button",{className:"logout",onClick:f,children:"Покинуть чат"})]})]})]})},js=({onClose:a})=>{const[i,h]=n.useState([]),[v,l]=n.useState(null),[x,p]=n.useState(""),[j,A]=n.useState(!1),{currentUser:I}=Z(),M=hs.debounce(async o=>{if(o.trim()===""){h([]);return}A(!0),l(null);try{const b=ae(E,"user"),y=(await De(b)).docs.map(F=>F.data()).filter(F=>F.username.toLowerCase().includes(o.toLowerCase())&&F.id!==I.id);h(y),y.length===0&&l("Пользователи не найдены")}catch(b){console.error(b),l("Ошибка при поиске пользователей")}finally{A(!1)}},300);n.useEffect(()=>(M(x),()=>M.cancel()),[x]);const D=async o=>{const b=ae(E,"chats"),G=ae(E,"userchats");try{const y=L(G,I.id),F=await Q(y);if(F.exists()&&(F.data().chats||[]).find(r=>r.receiverId===o.id)){l("Чат с этим пользователем уже существует");return}const f=L(b);await ne(f,{createdAt:ue(),messages:[]}),await Promise.all([W(L(G,o.id),{chats:re({chatId:f.id,lastMessage:"",receiverId:I.id,updatedAt:Date.now()})}),W(L(G,I.id),{chats:re({chatId:f.id,lastMessage:"",receiverId:o.id,updatedAt:Date.now()})})]),h(g=>g.filter(U=>U.id!==o.id)),l(null)}catch(y){console.error(y),l("Ошибка при создании чата")}};return e.jsxs("div",{className:"addUser",children:[e.jsx("button",{className:"close-btn",onClick:a,children:e.jsx(ps,{})}),e.jsxs("div",{className:"search-container",children:[e.jsx("input",{type:"text",placeholder:"Поиск пользователей...",value:x,onChange:o=>p(o.target.value),autoFocus:!0}),j&&e.jsx("div",{className:"spinner"})]}),v&&e.jsx("div",{className:"error",children:v}),e.jsx("div",{className:"user-list",children:i.map(o=>e.jsxs("div",{className:"user",children:[e.jsxs("div",{className:"detail",children:[e.jsx("img",{src:o.avatar||"../../../../../public/avatar.png",alt:o.username}),e.jsx("span",{children:o.username})]}),e.jsx("button",{onClick:()=>D(o),children:"Добавить"})]},o.id))})]})},Re="user",bs=({onClose:a})=>{const[i,h]=n.useState(""),[v,l]=n.useState(""),[x,p]=n.useState([]),[j,A]=n.useState(!0),[I,M]=n.useState([]),[D,o]=n.useState(!1),[b,G]=n.useState([]),{currentUser:y}=Z(),{changeChat:F}=ie();n.useEffect(()=>{(async()=>{if(y!=null&&y.id){A(!0);try{const d=L(E,"userchats",y.id),C=await Q(d);if(!C.exists()){p([]);return}const S=C.data().chats,N=new Set;S.forEach(R=>{R.isGroup?R.group&&R.group.members&&R.group.members.forEach(k=>{k!==y.id&&N.add(k)}):R.receiverId&&R.receiverId!==y.id&&N.add(R.receiverId)});const m=Array.from(N).map(async R=>{const k=L(E,Re,R),P=await Q(k);return P.exists()?{id:R,...P.data()}:null}),B=(await Promise.all(m)).filter(Boolean);p(B)}catch(d){console.error("Error fetching users from chats:",d)}finally{A(!1)}}})()},[y.id]);const f=async t=>{t.preventDefault();let C=new FormData(t.target).get("username");if(!C||C.trim()===""){M([]);return}C=C.trim(),o(!0),M([]);try{const S=ae(E,Re),N=es(S,ss("username","==",C)),m=await De(N),B=[];m.empty||m.forEach(k=>{const P=k.data();B.push({id:k.id,...P})});const R=B.filter(k=>k.id!==y.id&&!b.some(P=>P.id===k.id)&&!x.some(P=>P.id===k.id));M(R)}catch(S){console.error("Search error:",S),M([])}finally{o(!1)}},g=t=>{b.some(d=>d.id===t.id)||(G([...b,t]),l(""),M([]))},U=t=>{G(b.filter(d=>d.id!==t))},r=async()=>{if(!i.trim()||b.length===0)return;const t=ae(E,"chats"),d=ae(E,"userchats"),C=b.map(S=>S.id);try{const S=L(t),N={name:i.trim(),admin:y.id,members:[y.id,...C],createdAt:ue(),avatar:""};await ne(S,{createdAt:ue(),messages:[],isGroup:!0,group:N});const m=[y.id,...C],B={chatId:S.id,lastMessage:"",isGroup:!0,group:{name:N.name,avatar:N.avatar,admin:N.admin},updatedAt:Date.now(),isSeen:!1},R=m.map(async k=>{const P=L(d,k);(await Q(P)).exists()?await W(P,{chats:re(B)}):await ne(P,{chats:[B]})});await Promise.all(R),F(S.id,{id:S.id,isGroup:!0,group:N,user:{id:S.id,username:N.name,avatar:N.avatar||"../../../../public/avatar.png",isGroup:!0}}),a()}catch(S){console.error("Ошибка создания группы:",S)}},c=x.filter(t=>t.username.toLowerCase().includes(v.toLowerCase())&&t.id!==y.id&&!b.some(d=>d.id===t.id));return e.jsxs("div",{className:"addGroup",children:[e.jsxs("div",{className:"header",children:[e.jsx("h3",{children:"Создать групповой чат"}),e.jsx("button",{className:"closeBtn",onClick:a,children:"×"})]}),e.jsxs("div",{className:"groupInput",children:[e.jsx("label",{children:"Название группы"}),e.jsx("input",{type:"text",placeholder:"Введите название группы",value:i,onChange:t=>h(t.target.value),maxLength:30})]}),e.jsxs("div",{className:"searchSection",children:[e.jsxs("form",{onSubmit:f,children:[e.jsx("input",{type:"text",placeholder:"Поиск пользователей по точному имени",value:v,onChange:t=>l(t.target.value),name:"username"}),e.jsx("button",{type:"submit",disabled:D,children:D?"Поиск...":"Найти"})]}),D&&e.jsx("div",{className:"loadingIndicator",children:"Поиск..."}),!D&&I.length>0&&e.jsxs("div",{className:"searchResults",children:[e.jsx("h4",{children:"Результаты поиска:"}),I.map(t=>e.jsxs("div",{className:"userItem",children:[e.jsx("img",{src:t.avatar||"../../../../public/avatar.png",alt:t.username}),e.jsx("span",{children:t.username}),e.jsx("button",{onClick:()=>g(t),children:"Добавить"})]},t.id))]})]}),e.jsx("div",{className:"userListSection",children:j?e.jsx("div",{className:"loadingIndicator",children:"Загрузка контактов..."}):c.length===0?e.jsx("div",{className:"emptyState",children:"Нет контактов для добавления"}):e.jsxs(e.Fragment,{children:[e.jsx("h4",{children:"Ваши контакты:"}),e.jsx("div",{className:"contactsList",children:c.map(t=>e.jsxs("div",{className:"userItem",onClick:()=>g(t),children:[e.jsx("img",{src:t.avatar||"../../../../public/avatar.png",alt:t.username}),e.jsx("span",{children:t.username})]},t.id))})]})}),e.jsxs("div",{className:"membersSection",children:[e.jsxs("h4",{children:["Участники (",b.length+1,")"]}),e.jsxs("div",{className:"membersList",children:[e.jsxs("div",{className:"memberItem current",children:[e.jsx("img",{src:y.avatar||"../../../../public/avatar.png",alt:y.username}),e.jsxs("span",{children:[y.username," (Вы)"]})]}),b.map(t=>e.jsxs("div",{className:"memberItem",children:[e.jsx("img",{src:t.avatar||"../../../../public/avatar.png",alt:t.username}),e.jsx("span",{children:t.username}),e.jsx("button",{className:"removeBtn",onClick:()=>U(t.id),children:"×"})]},t.id))]})]}),e.jsxs("div",{className:"actionButtons",children:[e.jsx("button",{className:"cancelButton",onClick:a,children:"Отмена"}),e.jsx("button",{className:"createButton",onClick:r,disabled:!i.trim()||b.length===0,children:"Создать группу"})]})]})},Ns=()=>{const[a,i]=n.useState([]),[h,v]=n.useState(!1),[l,x]=n.useState(!1),[p,j]=n.useState(""),[A,I]=n.useState(!0),[M,D]=n.useState(null),{currentUser:o}=Z(),{chatId:b,changeChat:G}=ie();n.useEffect(()=>{if(!(o!=null&&o.id))return;const f=fe(L(E,"userchats",o.id),async g=>{var U;try{if(!g.exists()){i([]);return}const c=(((U=g.data())==null?void 0:U.chats)||[]).map(async d=>{var C,S;try{if(d.isGroup){const k=(await Q(L(E,"chats",d.chatId))).data();return{...d,user:{id:d.chatId,username:(k==null?void 0:k.chatName)||((C=d.group)==null?void 0:C.name)||"Групповой чат",avatar:(k==null?void 0:k.chatAvatar)||((S=d.group)==null?void 0:S.avatar)||"/avatar.png",isGroup:!0},lastMessage:d.lastMessage||"Нет сообщений"}}const N=L(E,"user",d.receiverId),B=(await Q(N)).data();return{...d,user:B||{blocked:[],username:"Удалённый пользователь",avatar:"/avatar.png",id:d.receiverId},lastMessage:d.lastMessage||"Нет сообщений"}}catch(N){return console.error("Ошибка загрузки пользователя:",N),{...d,user:{blocked:[],username:d.isGroup?"Групповой чат":"Ошибка загрузки",avatar:"/avatar.png",id:d.isGroup?d.chatId:d.receiverId,isGroup:d.isGroup},lastMessage:d.lastMessage||"Нет сообщений"}}}),t=await Promise.all(c);i(t.sort((d,C)=>(C.updatedAt||0)-(d.updatedAt||0))),D(null)}catch(r){console.error("Ошибка загрузки чатов:",r),D("Не удалось загрузить чаты"),i([])}finally{I(!1)}},g=>{console.error("Ошибка подписки на чаты:",g),D("Ошибка подключения"),I(!1)});return()=>f()},[o==null?void 0:o.id]);const y=async f=>{if(!(!(f!=null&&f.chatId)||!(o!=null&&o.id)))try{const g=a.map(r=>{const{user:c,...t}=r;return t}),U=g.findIndex(r=>r.chatId===f.chatId);if(U===-1)return;g[U].isSeen=!0,await W(L(E,"userchats",o.id),{chats:g}),G(f.chatId,f.user)}catch(g){console.error("Ошибка обновления чата:",g)}},F=a.filter(f=>{var g,U;return(U=(g=f.user)==null?void 0:g.username)==null?void 0:U.toLowerCase().includes(p.toLowerCase())});return A?e.jsx("div",{className:"chatList",children:"Загрузка чатов..."}):M?e.jsx("div",{className:"chatList error",children:M}):e.jsxs("div",{className:"chatList",children:[e.jsxs("div",{className:"search",children:[e.jsxs("div",{className:"searchBar",children:[e.jsx("img",{src:"/search.png",alt:"Поиск"}),e.jsx("input",{type:"text",placeholder:"Поиск",onChange:f=>j(f.target.value)})]}),e.jsx("img",{src:"/PeopleGroup.svg",alt:"Группы",className:"group",onClick:()=>x(!0)}),e.jsx("img",{src:h?"/minus.png":"/plus.png",alt:"Добавить",className:"add",onClick:()=>v(f=>!f)})]}),F.length===0?e.jsx("div",{className:"no-chats",children:"Нет чатов"}):F.map(f=>{var g,U,r,c,t,d,C,S;return e.jsxs("div",{className:"item",onClick:()=>y(f),style:{backgroundColor:f!=null&&f.isSeen?"transparent":"#434f2a",opacity:(U=(g=f.user)==null?void 0:g.blocked)!=null&&U.includes(o==null?void 0:o.id)?.6:1},children:[((r=f.user)==null?void 0:r.isGroup)&&e.jsx("span",{className:"group-badge",children:"Группа"}),e.jsx("img",{src:(t=(c=f.user)==null?void 0:c.blocked)!=null&&t.includes(o==null?void 0:o.id)?"/avatar.png":((d=f.user)==null?void 0:d.avatar)||"/avatar.png",alt:"Аватар",onError:N=>{N.target.src="/avatar.png"}},(C=f.user)==null?void 0:C.avatar),e.jsxs("div",{className:"texts",children:[e.jsx("span",{children:f.user?(S=f.user.blocked)!=null&&S.includes(o==null?void 0:o.id)?f.user.isGroup?"Групповой чат":"Пользователь":f.user.username||(f.user.isGroup?"Групповой чат":"Без имени"):"Удалённый пользователь"}),e.jsx("p",{children:f.lastMessage||"Нет сообщений"})]})]},f.chatId)}),h&&e.jsx(js,{onClose:()=>v(!1)}),l&&e.jsx(bs,{onClose:()=>x(!1)})]})},ws=()=>{const{currentUser:a,setCurrentUser:i}=Z(),[h,v]=n.useState(!1),[l,x]=n.useState((a==null?void 0:a.username)||""),[p,j]=n.useState(null),[A,I]=n.useState((a==null?void 0:a.avatar)||""),[M,D]=n.useState(!1),o=n.useRef(null),b=n.useRef(null),G=as(),y=()=>{v(!0),x((a==null?void 0:a.username)||""),I((a==null?void 0:a.avatar)||""),D(!1)},F=c=>{const t=c.target.files[0];t&&(j(t),I(URL.createObjectURL(t)))},f=async()=>{if(a!=null&&a.id)try{let c=a.avatar;if(p){const d=he(xe,`avatars/${a.id}`);await ts(d,p),c=await pe(d)}const t=L(E,"user",a.id);await W(t,{username:l,avatar:c}),i({...a,username:l,avatar:c}),K.success("Данные успешно обновлены!"),v(!1)}catch(c){console.error("Ошибка при обновлении данных:",c),K.error("Не удалось обновить данные")}},g=()=>{v(!1),I((a==null?void 0:a.avatar)||""),j(null)},U=async()=>{try{await rs(ce),i(null),G("/login"),K.success("Вы успешно вышли из аккаунта")}catch(c){console.error("Ошибка при выходе:",c),K.error("Не удалось выйти из аккаунта")}},r=c=>{c.stopPropagation(),D(!M)};return n.useEffect(()=>{const c=t=>{b.current&&!b.current.contains(t.target)&&D(!1)};return document.addEventListener("mousedown",c),()=>{document.removeEventListener("mousedown",c)}},[]),a?e.jsx("div",{className:"userInfo",children:h?e.jsxs("div",{className:"edit-form",children:[e.jsxs("div",{className:"avatar-edit",children:[e.jsx("img",{src:A||"../../../../public/avatar.png",alt:"Аватар",onClick:()=>o.current.click(),style:{cursor:"pointer"}}),e.jsx("input",{type:"file",ref:o,style:{display:"none"},onChange:F,accept:"image/*"}),e.jsx("p",{children:"Нажмите на аватар для изменения"})]}),e.jsx("input",{type:"text",value:l,onChange:c=>x(c.target.value),className:"username-input"}),e.jsxs("div",{className:"edit-buttons",children:[e.jsx("button",{onClick:f,className:"save-button",children:"Сохранить"}),e.jsx("button",{onClick:g,className:"cancel-button",children:"Отмена"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"user",children:[e.jsx("img",{src:a.avatar||"../../../../public/avatar.png",alt:"Аватар"}),e.jsx("h2",{children:a.username})]}),e.jsxs("div",{className:"icons",ref:b,children:[e.jsx("img",{src:"../../../../public/more.png",alt:"Меню",onClick:r,style:{cursor:"pointer"}}),M&&e.jsx("div",{className:"dropdown-menu",children:e.jsx("button",{onClick:U,className:"dropdown-item",children:"Выйти"})}),e.jsx("img",{src:"../../../../public/edit.png",alt:"Редактировать",onClick:y,style:{cursor:"pointer"}})]})]})}):null},ys=()=>e.jsxs("div",{className:"list",children:[e.jsx(ws,{}),e.jsx(Ns,{})]}),Cs=()=>{const[a,i]=n.useState({file:null,url:""}),[h,v]=n.useState(!1),l=j=>{j.target.files[0]&&i({file:j.target.files[0],url:URL.createObjectURL(j.target.files[0])})},x=async j=>{j.preventDefault(),v(!0);const A=new FormData(j.target),{username:I,email:M,password:D}=Object.fromEntries(A);try{const o=await is(ce,M,D);let b=a.file?await me(a.file):"../../../public/avatar.png";await ne(L(E,"user",o.user.uid),{username:I,email:M,avatar:b,id:o.user.uid,blocked:[]}),await ne(L(E,"userchats",o.user.uid),{chats:[]}),K.success("Аккаунт создан")}catch(o){K.error(o.message)}finally{v(!1)}},p=async j=>{j.preventDefault(),v(!0);const A=new FormData(j.target),{email:I,password:M}=Object.fromEntries(A);try{await ns(ce,I,M)}catch(D){console.log(D),K.error(D.message)}finally{v(!1)}};return e.jsxs("div",{className:"login",children:[e.jsxs("div",{className:"item",children:[e.jsx("h2",{children:"Добро пожаловать"}),e.jsxs("form",{onSubmit:p,children:[e.jsx("input",{type:"text",placeholder:"Email",name:"email"}),e.jsx("input",{type:"password",placeholder:"Password",name:"password"}),e.jsx("button",{disabled:h,children:h?"Загрузка":"Войти"})]})]}),e.jsx("div",{className:"separator"}),e.jsxs("div",{className:"item",children:[e.jsx("h2",{children:"Создать аккаунт"}),e.jsxs("form",{onSubmit:x,children:[e.jsxs("label",{htmlFor:"file",children:[e.jsx("img",{src:a.url||"../../../public/avatar.png",alt:""}),"Загрузить фото"]}),e.jsx("input",{type:"file",id:"file",style:{display:"none"},onChange:l}),e.jsx("input",{type:"text",placeholder:"Username",name:"username"}),e.jsx("input",{type:"text",placeholder:"Email",name:"email"}),e.jsx("input",{type:"password",placeholder:"Password",name:"password"}),e.jsx("button",{disabled:h,children:h?"Загрузка":"Зарегистрироваться"})]})]})]})},Ss=()=>e.jsx("div",{className:"",children:e.jsx(cs,{position:"bottom-right"})}),Rs=()=>{const{currentUser:a,isLoading:i,fetchUserInfo:h}=Z(),{chatId:v}=ie();return n.useEffect(()=>{const l=os(ce,x=>{h(x==null?void 0:x.uid)});return()=>{l()}},[h]),i?e.jsx("div",{className:"loading",children:"Загрузка..."}):e.jsx(ls,{children:e.jsxs("div",{className:"container",children:[e.jsxs(ds,{children:[e.jsx(Ce,{path:"/",element:a?e.jsxs(e.Fragment,{children:[e.jsx(ys,{}),v&&e.jsx(vs,{}),v&&e.jsx(gs,{})]}):e.jsx(Se,{to:"/login",replace:!0})}),e.jsx(Ce,{path:"/login",element:a?e.jsx(Se,{to:"/",replace:!0}):e.jsx(Cs,{})})]}),e.jsx(Ss,{})]})})};us.createRoot(document.getElementById("root")).render(e.jsx(ms.StrictMode,{children:e.jsx(Rs,{})}));
